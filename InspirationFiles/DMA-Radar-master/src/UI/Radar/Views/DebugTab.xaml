<UserControl x:Class="LoneEftDmaRadar.UI.Radar.Views.DebugTab"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:LoneEftDmaRadar.UI.Radar.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             Padding="10">

    <d:UserControl.DataContext>
        <d:DesignInstance Type="{x:Type vm:DebugTabViewModel}"
                          IsDesignTimeCreatable="False" />
    </d:UserControl.DataContext>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="380"/> <!-- Fixed width for left panel -->
            <ColumnDefinition Width="*"/>   <!-- Flexible width for Memory Inspector -->
        </Grid.ColumnDefinitions>

        <!-- Left Column: Existing Debug Utilities (Scrollable independently) -->
        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Margin="0,0,10,0">
            <StackPanel Orientation="Vertical">
                <TextBlock Text="Debug Utilities" FontSize="16" Margin="0,0,0,8" />

                <Button Content="Toggle Debug Console"
                        Width="200"
                        Height="36"
                        HorizontalAlignment="Left"
                        Command="{Binding ToggleDebugConsoleCommand}"
                        ToolTip="Shows or hides the console-based DebugLogger output." />

                <GroupBox Header="DeviceAimbot Aimbot Debug" Margin="0,12,0,0">
                    <StackPanel>
                        <CheckBox Content="Show Debug Overlay (ESP)"
                                  IsChecked="{Binding ShowDeviceAimbotDebug, Mode=TwoWay}"
                                  Margin="6,6,6,2"
                                  ToolTip="Shows detailed debug information on the ESP overlay"/>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Height="140" Margin="0,4,0,0">
                            <TextBlock Text="{Binding DeviceAimbotDebugText}"
                                       FontFamily="Consolas"
                                       FontSize="10"
                                       TextWrapping="Wrap"
                                       Margin="6" />
                        </ScrollViewer>
                    </StackPanel>
                </GroupBox>
        
                <GroupBox Header="InputManager Debug" Margin="0,12,0,0">
                    <StackPanel Margin="6">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="Status: " FontWeight="Bold" />
                            <TextBlock Text="{Binding InputManagerStatus}" />
                        </StackPanel>
                
                        <TextBlock Text="Detected Keys (Live):" FontWeight="Bold" Margin="0,4,0,2"/>
                        <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="2" Padding="4" MinHeight="24" Background="#252525">
                            <TextBlock Text="{Binding InputManagerKeys}" 
                                       FontFamily="Consolas" 
                                       Foreground="LightGreen" 
                                       TextWrapping="Wrap"/>
                        </Border>
                
                        <TextBlock Text="Values are Virtual Key Names." 
                                   Foreground="Gray" FontSize="10" Margin="0,4,0,0" TextWrapping="Wrap"/>
                           
                        <Button Content="Re-Initialize InputManager"
                                Margin="0,12,0,0"
                                Height="28"
                                Command="{Binding ReinitializeInputManagerCommand}"
                                ToolTip="Attempts to re-scan and initialize the InputManager. Check Console for logs."/>

                        <Button Content="Copy Debug Report to Clipboard"
                                Margin="0,8,0,0"
                                Height="28"
                                Command="{Binding CopyInputReportCommand}"
                                ToolTip="Copies a detailed technical report to clipboard for support."/>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- Right Column: Memory Inspector (Fills remaining space) -->
        <GroupBox Grid.Column="1" Header="Memory Inspector" Margin="0">
            <Grid Margin="6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="220"/> <!-- Wider struct list -->
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Header Controls -->
                    <RowDefinition Height="Auto"/> <!-- Detection Hints -->
                    <RowDefinition Height="*"/>    <!-- Data Content -->
                </Grid.RowDefinitions>

                <!-- Search Box -->
                <TextBox Grid.Column="0" Grid.Row="0"
                         Text="{Binding MemoryInspector.SearchText, UpdateSourceTrigger=PropertyChanged}"
                         ToolTip="Search structs or fields..."
                         Margin="0,0,8,4" Height="36" FontSize="14" VerticalContentAlignment="Center"/>
                
                <!-- Controls Row -->
                <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Text="Base:" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="14"/>
                    <TextBox Text="{Binding MemoryInspector.BaseAddressHex, UpdateSourceTrigger=PropertyChanged}"
                             Width="160" FontFamily="Consolas" FontSize="14" VerticalAlignment="Center" Height="36" VerticalContentAlignment="Center"/>
                    <Button Content="Read" Command="{Binding MemoryInspector.RefreshCommand}"
                            Width="50" Margin="4,0,0,0"/>
                    <CheckBox Content="Auto" IsChecked="{Binding MemoryInspector.AutoRefresh}"
                              VerticalAlignment="Center" Margin="8,0,0,0"
                              ToolTip="Auto-refresh values every 100ms"/>
                    <CheckBox Content="ESP" IsChecked="{Binding MemoryInspector.ShowOnEsp}"
                              VerticalAlignment="Center" Margin="8,0,0,0"
                              Foreground="LightGreen"
                              ToolTip="Display selected struct values on ESP overlay"/>
                    <TextBlock Text="{Binding MemoryInspector.AutoDetectHint}" 
                               VerticalAlignment="Center" Margin="10,0,0,0" 
                               Foreground="#00C8FF" FontSize="10" FontStyle="Italic"
                               ToolTip="Auto-detected base address source"/>
                </StackPanel>

                <!-- Struct Selection Labels with Back Button -->
                <StackPanel Grid.Column="0" Grid.Row="1" Orientation="Horizontal" Margin="0,0,8,4">
                    <Button Content="Back" Command="{Binding MemoryInspector.NavigateBackCommand}" 
                            IsEnabled="{Binding MemoryInspector.CanNavigateBack}"
                            Width="40" Height="20" FontSize="10" Margin="0,0,6,0"
                            ToolTip="Go back to previous struct"/>
                    <TextBlock Text="Select struct:" 
                               FontSize="10" Foreground="Gray" VerticalAlignment="Center"/>
                </StackPanel>
                
                <TextBlock Grid.Column="1" Grid.Row="1" 
                           Text="{Binding MemoryInspector.SelectedStruct.Name, FallbackValue='(none selected)'}" 
                           FontWeight="Bold" FontSize="10" Foreground="LightGreen" Margin="0,0,0,4"/>

                <!-- Struct List (Independent Scroll) -->
                <ListBox Grid.Column="0" Grid.Row="2"
                         ItemsSource="{Binding MemoryInspector.FilteredStructs}"
                         SelectedItem="{Binding MemoryInspector.SelectedStruct}"
                         DisplayMemberPath="Name"
                         FontSize="12"
                         Margin="0,0,8,0"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"/>

                <!-- Field DataGrid (Independent Scroll) -->
                <DataGrid Grid.Column="1" Grid.Row="2"
                          ItemsSource="{Binding MemoryInspector.CurrentFields}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CanUserReorderColumns="False"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column"
                          FontFamily="Consolas"
                          FontSize="11"
                          RowHeight="20"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <DataGrid.InputBindings>
                        <MouseBinding MouseAction="LeftDoubleClick" 
                                      Command="{Binding MemoryInspector.NavigateCommand}" 
                                      CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource FindAncestor, AncestorType=DataGrid}}"/>
                    </DataGrid.InputBindings>
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Field" Binding="{Binding Name}" Width="200"/>
                        <DataGridTextColumn Header="Offset" Binding="{Binding OffsetHex}" Width="60"/>
                        <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="LightGreen"/>
                                    <Setter Property="Padding" Value="4,0,0,0"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </GroupBox>
    </Grid>
</UserControl>
